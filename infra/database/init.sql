CREATE TABLE IF NOT EXISTS users (
    user_id UUID PRIMARY KEY,
    email VARCHAR(254) NOT NULL,
    sub VARCHAR(64) NOT NULL,
    nickname VARCHAR(30) NOT NULL,
    profile_image_url VARCHAR(2048),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_users_sub UNIQUE (sub)
);

CREATE TABLE user_agreement (
    user_agreement_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL,
    user_email VARCHAR(254) NOT NULL,
    user_nickname VARCHAR(30)  NOT NULL,
    agreed_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_deleted_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_user_agreement_user UNIQUE (user_id)
);

CREATE TABLE place (
    place_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(120) NOT NULL,        -- 장소명
    address VARCHAR(200) NOT NULL,     -- 도로명 주소
    district VARCHAR(50) NOT NULL,     -- 구/행정구역
    lat NUMERIC(9,6) NOT NULL,         -- 위도
    lng NUMERIC(9,6) NOT NULL,         -- 경도
    location GEOGRAPHY(Point, 4326),   -- 좌표
    type VARCHAR(20) NOT NULL,         -- 장소 유형 (Enum: RIVER_PARK, SQUARE, STREET)
    contact VARCHAR(150),              -- 연락처
    reservation_url VARCHAR(2048),     -- 예약 페이지 URL
    operation_time VARCHAR(100),       -- 운영시간
    available_days VARCHAR(50),        -- 사용 가능 요일
    fee VARCHAR(10),                   -- 이용요금 (Enum: FREE, PAID, UNKNOWN)
    max_performers VARCHAR(15),        -- 최대 인원 (Enum: LIMITED, UNLIMITED, UNKNOWN)
    how_to_apply VARCHAR(260),         -- 신청방법
    electricity_available BOOLEAN,     -- 전기 사용 가능 여부
    thumbnail_url VARCHAR(2048),       -- 썸네일 URL
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE favorite (
    favorite_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL,
    place_id BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_favorite_user FOREIGN KEY (user_id)
        REFERENCES users(user_id)
            ON DELETE CASCADE,          -- 유저 삭제 시 연관 즐겨찾기 자동 삭제
            CONSTRAINT fk_favorite_place FOREIGN KEY (place_id)
        REFERENCES place(place_id)
            ON DELETE CASCADE,          -- 장소 삭제 시 연관 즐겨찾기 자동 삭제
            CONSTRAINT uq_favorite_user_place UNIQUE (user_id, place_id)
);

CREATE TABLE review (
    review_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID,
    place_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_review_user FOREIGN KEY (user_id)
        REFERENCES users(user_id)
        ON DELETE SET NULL,        -- 유저 삭제 후에도 리뷰는 보존
    CONSTRAINT fk_review_place FOREIGN KEY (place_id)
        REFERENCES place(place_id)
        ON DELETE CASCADE          -- 장소 삭제 시 연관 리뷰 자동 삭제
);

CREATE INDEX idx_user_agreement_email
    ON user_agreement (user_email);

CREATE INDEX idx_user_agreement_nickname
    ON user_agreement (user_nickname);

INSERT INTO place (
    name, address, district, lat, lng, location, type, contact, reservation_url, operation_time, available_days, fee, max_performers, how_to_apply, electricity_available, thumbnail_url
) VALUES
      ('강서한강공원 (방화대교 남단)', '서울특별시 강서구 가양동 439-1', '강서구', 126.851691891551, 37.5697267155823, ST_SetSRID(ST_MakePoint(37.5697267155823, 126.851691891551), 4326)::geography, 'RIVER_PARK', '강서안내센터 (02-3780-0621~3)', 'https://hangang.seoul.go.kr/www/contents/894.do?mid=893', '10:00~20:00', '매일(연중)', 'FREE', 'LIMITED', '장소사용신청(전월 10일 까지) → 관할안내센터 승인 → 공연', FALSE, 'https://hangang.seoul.go.kr/www/file/down.do?fkey=03f778f7dfd22846a39917169747c91d844e65920d822a7f1302ca1bb09979bbfceef97a8e067e868c313da7650b8d1ab394f46d748bc9eaf89f3dbd470b1a42'),
      ('경의선숲길공원(연남동구간) 버스킹', '서울특별시 마포구 동교동 190-1', '마포구', 126.926498328277, 37.5577458058734, ST_SetSRID(ST_MakePoint(37.5577458058734, 126.926498328277), 4326)::geography, 'STREET', '경의선숲길공원 사무실 (02-719-8830)', 'https://yeyak.seoul.go.kr/web/reservation/selectReservView.do?rsv_svc_id=S241204090829416739&currentPage=1', '11:00~13:00, 14:00~16:00, 17:00~19:00', '매일', 'FREE', 'LIMITED', '온라인 예약 후 이용 가능', NULL, 'https://yeyak.seoul.go.kr/cmsdata/web_upload/svc/20241204/1733270978027BLUIPWF465NEIIE05F01QAHHW.jpg'),
      ('광나루한강공원 (천호대교 남단)', '서울특별시 송파구 풍납동 47-68', '송파구', 127.115493991413, 37.5419736536872, ST_SetSRID(ST_MakePoint(37.5419736536872, 127.115493991413), 4326)::geography, 'RIVER_PARK', '광나루안내센터 (02-3780-0501~4)', 'https://hangang.seoul.go.kr/www/contents/894.do?mid=892', '10:00~20:00', '매일(연중)', 'FREE', 'LIMITED', '장소사용신청(전월 10일 까지) → 관할안내센터 승인 → 공연', FALSE, 'https://hangang.seoul.go.kr/www/file/down.do?fkey=c188b125b95ab30170129553ecd5ee52706b16d5de6e3d5b8de72b80628606c94e965a4b8a475f72707bfc198be4e28c7495018b55b503ac08ed3998ad6f6040'),
      ('난지한강공원 (거울분수광장)', '서울특별시 마포구 상암동 1536-1', '마포구', 126.88981563725, 37.5599345342961, ST_SetSRID(ST_MakePoint(37.5599345342961, 126.88981563725), 4326)::geography, 'RIVER_PARK', '난지안내센터 (02-3780-0611~3)', 'https://hangang.seoul.go.kr/www/contents/894.do?mid=893', '10:00~20:00', '매일(연중)', 'FREE', 'LIMITED', '장소사용신청(전월 10일 까지) → 관할안내센터 승인 → 공연', FALSE, 'https://hangang.seoul.go.kr/www/file/down.do?fkey=282828cf19508daa868d3837d7eadea5eaeeacc165a5d444586b62c219c48a6c24df143b3d9243f10394af00f9d8a394fb7168c0f9eb22b8e338718314d3ad9a'),
      ('뚝섬한강공원 (장미공원)', '서울특별시 광진구 자양동 435', '광진구', 127.073807096279, 37.5278618984384, ST_SetSRID(ST_MakePoint(37.5278618984384, 127.073807096279), 4326)::geography, 'RIVER_PARK', '뚝섬안내센터 (02-3780-0521~4)', 'https://hangang.seoul.go.kr/www/contents/894.do?mid=893', '10:00~20:00', '매일(연중)', 'FREE', 'LIMITED', '장소사용신청(전월 10일 까지) → 관할안내센터 승인 → 공연', FALSE, 'https://hangang.seoul.go.kr/www/file/down.do?fkey=772ca3e3d27881d753474d6ad90af8261555538fe293f74eec8e61494e260e77c64d4cff4c7bd236de74818dcc7d94bbe537ace9b82ffcc84a53d2d9adf956f7'),
      ('마곡문화거리 버스킹존 1', '서울특별시 강서구 마곡중앙8로 32(마곡동)', '강서구', 126.830974669978, 37.5610929270592, ST_SetSRID(ST_MakePoint(37.5610929270592, 126.830974669978), 4326)::geography, 'STREET', '강서구 문화예술과 문화시설팀 (02-2600-6154)', 'https://yeyak.seoul.go.kr/web/reservation/selectReservView.do?rsv_svc_id=S250729103044913448&currentPage=1', '11:30 ~ 21:30', '매일', 'FREE', 'UNLIMITED', '이용일 기준 3일 전까지 선착순 사전 예약 및 승인 후 이용가능', TRUE, 'https://yeyak.seoul.go.kr/cmsdata/web_upload/svc/20250729/17537526448232UYCB43KI45NK7OEJX2YI3SBL.jpg');